namespace = isb

event = {
	id = isb.1
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		#every_country = {
		#	limit = { is_ai = yes }
		#	add_modifier = {
		#		modifier = "ai_ship_upkeep"
		#		days = -1
		#	}
		#}

		every_country = {
			limit = {
				is_country_type = fallen_empire
			}
			add_modifier = {
				modifier = "fallen_ship_upkeep"
				days = -1
			}
		}

		#every_country = {
		#	limit = { is_ai = no }
		#	add_modifier = {
		#		modifier = "test_mode"
		#		days = -1
		#	}
		#}
	}
}

# Test mode
event = {
	id = isb.99
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		every_country = {
			limit = { is_ai = no }
			add_modifier = {
				modifier = "test_mode"
				days = -1
			}
		}
	}
}

# Test mode off
event = {
	id = isb.98
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		every_country = {
			limit = { is_ai = no }
			remove_modifier = "test_mode"
		}
	}
}

# clears difficulty buffs from swarm / ed and global flags
country_event = {
	id = isb.6
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		if = {
			limit = {
				has_global_flag = flag_crisis_easy
			}

			remove_global_flag = flag_crisis_easy
		}

		if = {
			limit = {
				has_global_flag = flag_crisis_hard
			}

			remove_global_flag = flag_crisis_hard
		}

		every_country = {
			limit = {
				OR = {
					is_country_type = swarm
					is_country_type = extradimensional
					is_country_type = extradimensional_2
					is_country_type = extradimensional_3
				}
			}

			if = {
				limit = {
					has_modifier = mod_crisis_easy
				}

				remove_modifier = "mod_crisis_easy"
			}

			if = {
				limit = {
					has_modifier = mod_crisis_hard
				}

				remove_modifier = "mod_crisis_hard"
			}
		}
	}
}

country_event = {
	id = isb.7
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		if = {
			limit = {
				has_global_flag = flag_crisis_easy
			}
			add_modifier = {
				modifier = mod_crisis_easy
				days = -1
			}
			else = {
				if = {
					limit = {
						has_global_flag = flag_crisis_hard
					}
					add_modifier = {
						modifier = mod_crisis_hard
						days = -1
					}
				}
			}
		}
	}
}

# Crisis check for opinion boost every 5 years.
event = {
	id = isb.2
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		# initialise and reset
		if = {
			limit = {
				has_global_flag = crisis_threat_low
			}

			remove_global_flag = crisis_threat_low
		}

		if = {
			limit = {
				has_global_flag = crisis_threat_med
			}

			remove_global_flag = crisis_threat_med
		}

		if = {
			limit = {
				has_global_flag = crisis_threat_high
			}

			remove_global_flag = crisis_threat_high
		}

		random_country = {
			save_event_target_as = crisis_var
			set_variable = {
				which = "crisis_threat_count"
				value = 1
			}
		}

		# ed 1 threat
		if = {
			random_country = {
				limit = {
					is_country_type = extradimensional
				}

				random_country = {
					limit = {
						is_same_value = event_target:crisis_var
					}
					change_variable = {
						which = "crisis_threat_count"
						value = 1
					}
				}

				# ~5 stations per system, 5 systems
				if = {
					limit = {
						count_owned_ships = {
							limit = { is_ship_size = military_station_large_ed }
							count > 24
						}
					}
					random_country = {
						limit = {
							is_same_value = event_target:crisis_var
						}
						change_variable = {
							which = "crisis_threat_count"
							value = 1
						}
					}

					# 10 systems
					if = {
						limit = {
							count_owned_ships = {
								limit = { is_ship_size = military_station_large_ed }
								count > 49
							}
						}
						random_country = {
							limit = {
								is_same_value = event_target:crisis_var
							}
							change_variable = {
								which = "crisis_threat_count"
								value = 1
							}
						}

						# 20 systems
						if = {
							limit = {
								count_owned_ships = {
									limit = { is_ship_size = military_station_large_ed }
									count > 99
								}
							}
							random_country = {
								limit = {
									is_same_value = event_target:crisis_var
								}
								change_variable = {
									which = "crisis_threat_count"
									value = 2
								}
							}
						}
					}
				}
			}
		}

		# ed 2 threat
		if = {
			random_country = {
				limit = {
					is_country_type = extradimensional_2
				}

				random_country = {
					limit = {
						is_same_value = event_target:crisis_var
					}
					change_variable = {
						which = "crisis_threat_count"
						value = 1
					}
				}

				# ~5 stations per system, 5 systems
				if = {
					limit = {
						count_owned_ships = {
							limit = { is_ship_size = military_station_large_ed }
							count > 24
						}
					}
					random_country = {
						limit = {
							is_same_value = event_target:crisis_var
						}
						change_variable = {
							which = "crisis_threat_count"
							value = 1
						}
					}

					# 10 systems
					if = {
						limit = {
							count_owned_ships = {
								limit = { is_ship_size = military_station_large_ed }
								count > 49
							}
						}
						random_country = {
							limit = {
								is_same_value = event_target:crisis_var
							}
							change_variable = {
								which = "crisis_threat_count"
								value = 1
							}
						}

						# 20 systems
						if = {
							limit = {
								count_owned_ships = {
									limit = { is_ship_size = military_station_large_ed }
									count > 99
								}
							}
							random_country = {
								limit = {
									is_same_value = event_target:crisis_var
								}
								change_variable = {
									which = "crisis_threat_count"
									value = 2
								}
							}
						}
					}
				}
			}
		}

		# ed 3 threat
		if = {
			random_country = {
				limit = {
					is_country_type = extradimensional_3
				}

				random_country = {
					limit = {
						is_same_value = event_target:crisis_var
					}
					change_variable = {
						which = "crisis_threat_count"
						value = 1
					}
				}

				# ~5 stations per system, 5 systems
				if = {
					limit = {
						count_owned_ships = {
							limit = { is_ship_size = military_station_large_ed }
							count > 24
						}
					}
					random_country = {
						limit = {
							is_same_value = event_target:crisis_var
						}
						change_variable = {
							which = "crisis_threat_count"
							value = 1
						}
					}

					# 10 systems
					if = {
						limit = {
							count_owned_ships = {
								limit = { is_ship_size = military_station_large_ed }
								count > 49
							}
						}
						random_country = {
							limit = {
								is_same_value = event_target:crisis_var
							}
							change_variable = {
								which = "crisis_threat_count"
								value = 1
							}
						}

						# 20 systems
						if = {
							limit = {
								count_owned_ships = {
									limit = { is_ship_size = military_station_large_ed }
									count > 99
								}
							}
							random_country = {
								limit = {
									is_same_value = event_target:crisis_var
								}
								change_variable = {
									which = "crisis_threat_count"
									value = 2
								}
							}
						}
					}
				}
			}
		}

		# swarm threat
		if = {
			random_country = {
				limit = {
					is_country_type = swarm
				}

				random_country = {
					limit = {
						is_same_value = event_target:crisis_var
					}
					change_variable = {
						which = "crisis_threat_count"
						value = 3
					}
				}

				# Count planets
				if = {
					limit = {
						num_owned_planets > 10
					}
					random_country = {
						limit = {
							is_same_value = event_target:crisis_var
						}
						change_variable = {
							which = "crisis_threat_count"
							value = 1
						}
					}

					# 25 systems
					if = {
						limit = {
							num_owned_planets > 24
						}
						random_country = {
							limit = {
								is_same_value = event_target:crisis_var
							}
							change_variable = {
								which = "crisis_threat_count"
								value = 5
							}
						}

						# 50 systems
						if = {
							limit = {
								num_owned_planets > 49
							}
							random_country = {
								limit = {
									is_same_value = event_target:crisis_var
								}
								change_variable = {
									which = "crisis_threat_count"
									value = 8
								}
							}
						}
					}
				}
			}
		}

		# AI threat. Didn't buff this crisis so count it as weak for now
		if = {
			random_country = {
				limit = {
					is_country_type = ai_empire
				}

				random_country = {
					limit = {
						is_same_value = event_target:crisis_var
					}
					change_variable = {
						which = "crisis_threat_count"
						value = 3
					}
				}

				# Count planets
				if = {
					limit = {
						num_owned_planets > 10
					}
					random_country = {
						limit = {
							is_same_value = event_target:crisis_var
						}
						change_variable = {
							which = "crisis_threat_count"
							value = 3
						}
					}

					# 25 systems
					if = {
						limit = {
							num_owned_planets > 24
						}
						random_country = {
							limit = {
								is_same_value = event_target:crisis_var
							}
							change_variable = {
								which = "crisis_threat_count"
								value = 3
							}
						}
					}
				}
			}
		}

		random_country = {
			limit = {
				is_same_value = event_target:crisis_var
			}

			if = {
				limit = {
					check_variable = {
						which = "crisis_threat_count"
						value > 1
					}
				}
				set_global_flag = crisis_threat_low

				if = {
					limit = {
						check_variable = {
							which = "crisis_threat_count"
							value > 8
						}
					}
					set_global_flag = crisis_threat_med

					if = {
						limit = {
							check_variable = {
								which = "crisis_threat_count"
								value > 16
							}
						}
						set_global_flag = crisis_threat_high
					}
				}

				every_country = {
					limit = {
						is_ai = no
						OR = {
							is_country_type = default
							is_country_type = fallen_empire
						}
					}

					save_event_target_as = crisis_checker

					every_country = {
						limit = {
							has_communications = PREV
							NOT = { is_country = PREV }
							OR = {
								is_country_type = default
								is_country_type = fallen_empire
							}
						}

						add_opinion_modifier = { who = event_target:crisis_checker modifier = opinion_crisis_threat }
						if = {
							limit = {
								has_global_flag = crisis_threat_med
							}
							add_opinion_modifier = { who = event_target:crisis_checker modifier = opinion_crisis_threat }

							if = {
								limit = {
									has_global_flag = crisis_threat_high
								}
								add_opinion_modifier = { who = event_target:crisis_checker modifier = opinion_crisis_threat }
							}
						}
					}
				}

				# remove global flags
				if = {
					limit = {
						has_global_flag = crisis_threat_low
					}

					remove_global_flag = crisis_threat_low
				}

				if = {
					limit = {
						has_global_flag = crisis_threat_med
					}

					remove_global_flag = crisis_threat_med
				}

				if = {
					limit = {
						has_global_flag = crisis_threat_high
					}

					remove_global_flag = crisis_threat_high
				}
			}
		}
	}
}

# Strengthen Guardians every 50 years, up to 200 years
event = {
	id = isb.4
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		every_country = {
			limit = {
				is_guardian_country = yes
			}

			country_event = { id = isb.5 }
		}
	}
}

# Country buff for guardians
country_event = {
	id = isb.5
	hide_window = yes
	is_triggered_only = yes

	immediate = {
		if = {
			limit = {
				years_passed > 49
				NOT = { has_country_flag = flag_guardian_buff_50 }
			}

			set_country_flag = flag_guardian_buff_50
			add_modifier = {
				modifier = "mod_guardian_buff_50"
				days = -1
			}

			if = {
				limit = {
					years_passed > 99
					NOT = { has_country_flag = flag_guardian_buff_100 }
				}

				set_country_flag = flag_guardian_buff_100
				add_modifier = {
					modifier = "mod_guardian_buff_100"
					days = -1
				}

				if = {
					limit = {
						years_passed > 149
						NOT = { has_country_flag = flag_guardian_buff_150 }
					}

					set_country_flag = flag_guardian_buff_150
					add_modifier = {
						modifier = "mod_guardian_buff_150"
						days = -1
					}

					if = {
						limit = {
							years_passed > 199
							NOT = { has_country_flag = flag_guardian_buff_200 }
						}

						set_country_flag = flag_guardian_buff_200
						add_modifier = {
							modifier = "mod_guardian_buff_200"
							days = -1
						}
					}
				}
			}
		}
	}
}